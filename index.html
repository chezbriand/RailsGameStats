<!DOCTYPE html>
<html>
<head>
    <title>Game Analyzer</title>
    <meta http-equiv="Permissions-Policy" content="interest-cohort=()">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <p>Rail Game Analyzer v<span id="versionDisplay"></span></p>

    <script>
        // Read the metadata.json file (adjust the path as needed)
        fetch('metadata.json')
            .then(response => response.json())
            .then(metadata => {
                // Increment the build revision
                // metadata.buildRevision += 1;

                // Construct the displayable version string
                const displayableVersion = `${metadata.buildMajor}.${metadata.buildMinor}.${metadata.buildRevision} ${metadata.buildTag}`;

                // Update the span element with the version
                document.getElementById('versionDisplay').textContent = displayableVersion;
            })
            .catch(error => console.error('Error reading metadata:', error));
    </script>

    <textarea id="inputArea" rows="10" cols="80" placeholder="Paste Game History here..."></textarea><br>
    Starting Money: <input id="startingMoney" type="number" value="60"><br>
    <button onclick="analyzeGame()">Analyze</button>
    <div id="stats" style="background-color: rgb(243, 212, 155); padding: 5px;"></div>
    <canvas id="myChart"></canvas>

    <script>

        var myChart1 = null;

        function parseAmount(action) {
            var match = action.match(/\$(\d+)/);
            return match ? parseInt(match[1]) : 0;
        }

        function parseSegments(action) {
            var match = action.match(/Built (\d+) segments/);
            return match ? parseInt(match[1]) : 0;
        }

        function parseMovement(action) {
            var match = action.match(/Moved (\d+) spaces/);
            return match ? parseInt(match[1]) : 0;
        }

        function analyzeGame() {
            var text = document.getElementById('inputArea').value;
            var startingMoney = parseInt(document.getElementById('startingMoney').value);
            var lines = text.trim().split('\n').reverse();
            var players = {};
            var currentRounds = {};
            var rounds = [];
            var segmentsBuilt = {};
            var segmentsCost = {};
            var loadsDelivered = {};
            var loadsRevenue = {};
            var milepostsMoved = {};
            var actionsByRound = {};

            lines.forEach(line => {
                var parts = line.split('\t');
                var round = parts[0];
                var player = parts[1];
                var action = parts[2];

                if (!players[player]) {
                    players[player] = { money: startingMoney, history: [] };
                    currentRounds[player] = null;
                    segmentsBuilt[player] = 0;
                    segmentsCost[player] = 0;
                    loadsDelivered[player] = 0;
                    loadsRevenue[player] = 0;
                    milepostsMoved[player] = 0;
                }

                if (currentRounds[player] != round) {
                    players[player].history.push(players[player].money);
                    currentRounds[player] = round;
                }

                if (action.startsWith("Built")) {
                    var cost = parseAmount(action);
                    players[player].money -= cost;
                    segmentsBuilt[player] += parseSegments(action);
                    segmentsCost[player] += cost;
                } else if (action.startsWith("Upgraded") || action.startsWith("Player was taxed")) {
                    players[player].money -= parseAmount(action);
                } else if (action.startsWith("Delivered")) {
                    var revenue = parseAmount(action);
                    players[player].money += revenue;
                    loadsDelivered[player] += 1;
                    loadsRevenue[player] += revenue;
                } else if (action.includes("for rent to")) {
                    var rent = parseAmount(action);
                    players[player].money -= rent;
                    var recipient = action.split("for rent to")[1].trim();
                    if (recipient && recipient in players) {
                        if (currentRounds[recipient] != round) {
                            players[recipient].history.push(players[recipient].money + rent);
                            currentRounds[recipient] = round;
                        } else {
                            players[recipient].money += rent;
                        }
                    }
                } else if (action.startsWith("Moved")) {
                    var movement = parseMovement(action);
                    milepostsMoved[player] += movement;
                }

                if (!rounds.includes(round)) {
                    rounds.push(round);
                }
                if (!actionsByRound[round]) {
                    actionsByRound[round] = [];
                }
                actionsByRound[round].push(player + " " + action);
            });

            // Add the final money totals for each player
            for (var player in players) {
                players[player].history.push(players[player].money);
            }

            var statsText = "";
            var winner = Object.keys(players).reduce((a, b) => players[a].money > players[b].money ? a : b);
            var gameIsOver = Object.values(players).some(player => player.money > 250);

            if (gameIsOver) {
                statsText += "There were " + (rounds.length) + " rounds, and ";
                statsText += "the winner was " + winner + ".<br>";
            } else {
                statsText += "So far, there have been " + (rounds.length) + " rounds, and ";
                statsText += "the current leader is " + winner + ".<br>";
            }

            for (var player in players) {
                statsText += player + " built " + segmentsBuilt[player] + " segments for $" + segmentsCost[player] + " delivering " + loadsDelivered[player] + " loads for $" + loadsRevenue[player] + " with " + milepostsMoved[player] + " movements.<br>";
            }


            document.getElementById('stats').innerHTML = statsText;

            var datasets = [];
            var colors = ['blue', 'red', 'orange', 'yellow', 'green', 'purple', 'black', 'pink'];
            var colorIndex = 0;
            for (var player in players) {
                datasets.push({
                    label: player,
                    data: players[player].history,
                    fill: false,
                    borderColor: colors[colorIndex % colors.length],
                });
                colorIndex++;
            }
            
            var ctx = document.getElementById('myChart').getContext('2d');
            if (myChart1) {
                myChart1.destroy();
            }
            myChart1 = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [0].concat(rounds), 
                    datasets: datasets,
                },
                options: {
                    responsive: true,
                    title: {
                        display: true,
                        text: 'Player Money Over Time'
                    },
                    scales: {
                        xAxes: [{
                            display: true,
                            scaleLabel: {
                                display: true,
                                labelString: 'Round'
                            },
                            ticks: {
                                beginAtZero: true
                            }
                        }],
                        yAxes: [{
                            display: true,
                            scaleLabel: {
                                display: true,
                                labelString: 'Money'
                            }
                        }]
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                footer: function(tooltipItem) {
                                    var round = tooltipItem[0].dataIndex;
                                    return actionsByRound[round];
                                }
                            }
                        }

                    }
                }
            });
        }
    </script>
</body>
</html>
